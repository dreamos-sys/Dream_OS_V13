<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10b981">
    <meta name="description" content="Dream OS v13.4 - The Power Soul of Shalawat">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DREAM OS v13.4 | THE POWER SOUL</title>

    <!-- Tailwind CSS (lightweight) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+Arabic:wght@700;900&display=swap" rel="stylesheet">

    <!-- Supabase (core) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Heavy libraries dimuat async agar tidak blocking -->
    <script async src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script async src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: #0f172a; color: white; overflow-x: hidden; }
        .font-arabic { font-family: 'Noto Sans Arabic', sans-serif; }

        /* Glassmorphism */
        .glass-light {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        }
        .dark-mode .glass-light {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(255,255,255,0.05);
        }

        /* Card icon */
        .icon-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .icon-card:active { transform: scale(0.95); }
        .icon-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(16,185,129,0.15); }

        /* Toast */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 12px 24px;
            border-radius: 40px; color: white; font-weight: 700; font-size: 12px;
            z-index: 10000; animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-warning { background: #f59e0b; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Spinner */
        .spinner {
            border: 3px solid rgba(16,185,129,0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom scroll */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }

        /* Slider dots */
        .dot-slide {
            width: 8px; height: 8px; border-radius: 50%;
            background: #94a3b8; transition: all 0.3s; cursor: pointer;
        }
        .dot-slide.active {
            background: #10b981; transform: scale(1.3);
        }
        #info-slider { transition: transform 0.5s ease-in-out; }

        /* Login background animation (ringan) */
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.02); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 15px rgba(16,185,129,0.3); }
            50% { text-shadow: 0 0 30px rgba(16,185,129,0.5); }
        }
        .animate-glow { animation: glow 3s ease-in-out infinite; }

        /* Fade up */
        .animate-up { animation: fadeUp 0.6s ease-out forwards; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 min-h-screen flex items-center justify-center">

    <!-- Toast container -->
    <div id="toast-container"></div>

    <!-- ========== LOGIN ZONE (FUTURISTIC, RINGAN) ========== -->
    <div id="login-zone" class="fixed inset-0 z-[999] flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900/50 to-slate-900 overflow-hidden">
        <!-- Background subtle moving orbs (CSS only) -->
        <div class="absolute inset-0 opacity-20">
            <div class="absolute top-10 left-10 w-64 h-64 bg-emerald-500 rounded-full mix-blend-multiply filter blur-3xl animate-pulse"></div>
            <div class="absolute bottom-10 right-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl animate-pulse animation-delay-2000"></div>
        </div>

        <div class="relative w-full max-w-md p-6 mx-4">
            <div class="backdrop-blur-xl bg-white/10 border border-white/20 rounded-[3rem] shadow-2xl p-8 text-center transition-all duration-300">
                <!-- Logo -->
                <div class="relative mx-auto w-24 h-24 mb-4">
                    <img src="1001060756.png" class="w-full h-full object-contain drop-shadow-2xl animate-float" onerror="this.src='https://via.placeholder.com/100?text=OS'">
                </div>

                <div class="mb-2">
                    <span class="px-4 py-1 bg-emerald-500/20 text-emerald-300 rounded-full text-[10px] font-mono border border-emerald-500/30">v13.4 MASTER</span>
                </div>

                <div class="font-arabic text-3xl text-emerald-400 mb-2 font-black animate-glow">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê</div>
                <p class="text-[9px] uppercase tracking-widest text-white/40 mb-6 italic font-mono">The Power Soul of Shalawat</p>

                <!-- Input password -->
                <div class="relative mb-6 group">
                    <input type="password" id="access-key"
                        class="w-full bg-transparent border-2 border-white/20 rounded-2xl px-6 py-4 text-white placeholder-white/40 font-mono text-sm focus:outline-none focus:border-emerald-400 transition-colors peer"
                        placeholder=" ">
                    <label for="access-key" class="absolute left-6 -top-3 bg-slate-900/80 px-2 text-[10px] text-emerald-400 font-bold uppercase tracking-wider opacity-0 peer-focus:opacity-100 peer-placeholder-shown:opacity-0 transition-all duration-300 backdrop-blur-sm rounded-full border border-emerald-500/30">Master Key</label>
                    <i id="toggleEye" class="fas fa-eye absolute right-5 top-1/2 -translate-y-1/2 text-white/40 cursor-pointer hover:text-emerald-400 transition-colors"></i>
                </div>

                <!-- Login button -->
                <button id="btnLogin" onclick="checkAccess()"
                    class="relative w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-emerald-500/30 overflow-hidden active:scale-95 transition-transform">
                    <span class="relative z-10 text-sm tracking-widest uppercase">Verifikasi Akses</span>
                </button>

                <!-- Error & lockout -->
                <p id="error-msg" class="text-red-400 text-[9px] mt-4 opacity-0 font-bold uppercase tracking-widest italic"></p>
                <p id="lockout-timer" class="text-orange-400 text-[10px] mt-4 hidden font-black"></p>

                <div class="mt-8 text-[8px] text-white/30 font-mono">
                    <p>üîê ISO 27001 Certified Access Control</p>
                    <p>üì± Authorized: Redmi Note 9 Pro</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MAIN APP SHELL ========== -->
    <div id="app-shell" class="hidden w-full max-w-7xl mx-auto space-y-6 animate-up">

        <!-- Header dengan stats & slider shalawat -->
        <header class="w-full glass-light rounded-[2.5rem] p-6 relative">
            <!-- Slider shalawat (3 slide) -->
            <div id="shalawat-slider" class="h-16 flex flex-col justify-center items-center mb-4"></div>

            <!-- Stats cards -->
            <div class="grid grid-cols-4 gap-3 mb-4">
                <div class="stats-card bg-emerald-50 dark:bg-slate-800 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">Booking</p>
                    <p id="stat-booking" class="text-lg font-black text-emerald-600 dark:text-emerald-400">0</p>
                </div>
                <div class="stats-card bg-orange-50 dark:bg-slate-800 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">K3</p>
                    <p id="stat-k3" class="text-lg font-black text-orange-600 dark:text-orange-400">0</p>
                </div>
                <div class="stats-card bg-purple-50 dark:bg-slate-800 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">Dana</p>
                    <p id="stat-dana" class="text-lg font-black text-purple-600 dark:text-purple-400">0</p>
                </div>
                <div class="stats-card bg-blue-50 dark:bg-slate-800 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">Security</p>
                    <p id="stat-security" class="text-lg font-black text-blue-600 dark:text-blue-400">SAFE</p>
                </div>
            </div>

            <!-- User info & clock -->
            <div class="flex justify-between items-center mt-2 px-2 border-t border-slate-200 dark:border-slate-700 pt-4">
                <div class="flex items-center gap-3">
                    <div id="user-badge" class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-800 flex items-center justify-center text-emerald-600 dark:text-emerald-300 font-black text-xs">?</div>
                    <div>
                        <h1 class="text-[10px] font-black uppercase text-slate-900 dark:text-white">User: <span id="user-display" class="text-emerald-600 italic">-</span></h1>
                        <p class="text-[8px] text-slate-500 dark:text-slate-400 font-bold uppercase italic">Mode: <span id="mode-tag">-</span></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="clock" class="text-[11px] font-black bg-emerald-50 dark:bg-slate-800 px-4 py-2 rounded-full text-emerald-600 dark:text-emerald-400 shadow-sm font-mono">00:00:00</div>
                    <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-emerald-100 dark:hover:bg-emerald-900 transition">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- ===== 7-SLIDE INFO PANEL ===== -->
        <div class="relative overflow-hidden rounded-[2.5rem] glass-light p-2">
            <div id="info-slider" class="flex">
                <!-- Slide 1: Greeting -->
                <div class="min-w-full p-6 text-center">
                    <div class="font-arabic text-4xl text-emerald-400 mb-2 animate-glow">ÿßŸÑÿ≥ŸéŸëŸÑŸéÿßŸÖŸè ÿπŸéŸÑŸéŸäŸíŸÉŸèŸÖŸí</div>
                    <h2 class="text-xl font-black text-slate-800 dark:text-white">Selamat Datang, <span id="user-name-display">Admin</span>!</h2>
                    <p class="text-xs text-slate-500 mt-2">Silakan pilih modul yang Anda butuhkan. Terima kasih.</p>
                </div>
                <!-- Slide 2: Booking Hari Ini -->
                <div class="min-w-full p-6">
                    <h3 class="text-sm font-black text-emerald-600 mb-2 flex items-center gap-2">üìÖ Booking Hari Ini</h3>
                    <div id="today-booking-list" class="space-y-2 max-h-32 overflow-y-auto text-xs">
                        <p class="text-slate-400">Memuat...</p>
                    </div>
                    <button onclick="openModule('booking')" class="mt-3 bg-emerald-500/20 text-emerald-600 px-4 py-2 rounded-full text-[10px] font-black w-full">+ Booking Baru</button>
                </div>
                <!-- Slide 3: K3 Hari Ini -->
                <div class="min-w-full p-6">
                    <h3 class="text-sm font-black text-orange-600 mb-2 flex items-center gap-2">‚ö†Ô∏è K3 Hari Ini</h3>
                    <div id="today-k3-list" class="space-y-2 max-h-32 overflow-y-auto text-xs">
                        <p class="text-slate-400">Memuat...</p>
                    </div>
                    <button onclick="openModule('k3')" class="mt-3 bg-orange-500/20 text-orange-600 px-4 py-2 rounded-full text-[10px] font-black w-full">+ Lapor K3</button>
                </div>
                <!-- Slide 4: Cuaca & Mitigasi -->
                <div class="min-w-full p-6">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span id="weather-icon-big" class="text-4xl">üå§Ô∏è</span>
                            <div>
                                <p id="weather-temp-big" class="text-2xl font-black">--¬∞C</p>
                                <p id="weather-desc-big" class="text-[10px] uppercase text-cyan-500">--</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] text-slate-400">Kelembaban <span id="weather-humidity">--%</span></p>
                            <p class="text-[9px] text-slate-400">Angin <span id="weather-wind">-- km/h</span></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded-xl">
                            <p class="text-[8px] text-slate-500">üö¶ Lalu Lintas</p>
                            <p id="traffic-status" class="text-xs font-black text-emerald-600">Lancar</p>
                        </div>
                        <div class="bg-slate-100 dark:bg-slate-800 p-2 rounded-xl">
                            <p class="text-[8px] text-slate-500">üåã Mitigasi</p>
                            <p id="disaster-status" class="text-xs font-black text-yellow-600">Aman</p>
                        </div>
                    </div>
                </div>
                <!-- Slide 5: Pengumuman Admin -->
                <div class="min-w-full p-6">
                    <h3 class="text-sm font-black text-purple-600 mb-2 flex items-center gap-2">üì¢ Pengumuman</h3>
                    <div id="admin-announcement" class="text-sm bg-slate-800/30 p-4 rounded-2xl border border-purple-500/30">
                        <p class="text-xs italic">Memuat...</p>
                    </div>
                </div>
                <!-- Slide 6: Konten Dinamis 1 -->
                <div class="min-w-full p-6">
                    <h3 class="text-sm font-black text-blue-600 mb-2">üìã Info Tambahan 1</h3>
                    <div id="dynamic-slide-6" class="text-sm bg-slate-800/30 p-4 rounded-2xl border border-blue-500/30">
                        <p class="text-xs italic">-</p>
                    </div>
                </div>
                <!-- Slide 7: Konten Dinamis 2 -->
                <div class="min-w-full p-6">
                    <h3 class="text-sm font-black text-pink-600 mb-2">üìã Info Tambahan 2</h3>
                    <div id="dynamic-slide-7" class="text-sm bg-slate-800/30 p-4 rounded-2xl border border-pink-500/30">
                        <p class="text-xs italic">-</p>
                    </div>
                </div>
            </div>
            <!-- Dots navigasi -->
            <div class="flex justify-center gap-2 mt-2 pb-2">
                <div class="dot-slide active"></div>
                <div class="dot-slide"></div>
                <div class="dot-slide"></div>
                <div class="dot-slide"></div>
                <div class="dot-slide"></div>
                <div class="dot-slide"></div>
                <div class="dot-slide"></div>
            </div>
        </div>

        <!-- ===== GRID MODUL (9 ikon) ===== -->
        <div id="grid-container" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-12"></div>

        <!-- Footer -->
        <footer class="text-center space-y-3 pb-10">
            <p class="text-[9px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest italic">The Power Soul of Shalawat</p>
            <div class="flex justify-center gap-4">
                <button onclick="backup()" class="bg-blue-50 dark:bg-slate-800 text-blue-500 dark:text-blue-400 text-[10px] font-black px-6 py-3 rounded-full border border-blue-100 dark:border-blue-900 uppercase tracking-widest active:scale-90 transition shadow-sm">üíæ Backup</button>
                <button onclick="exportData()" class="bg-purple-50 dark:bg-slate-800 text-purple-500 dark:text-purple-400 text-[10px] font-black px-6 py-3 rounded-full border border-purple-100 dark:border-purple-900 uppercase tracking-widest active:scale-90 transition shadow-sm">üìä Export</button>
            </div>
            <button onclick="logout()" class="bg-red-50 dark:bg-slate-800 text-red-500 dark:text-red-400 text-[10px] font-black px-10 py-3 rounded-full border border-red-100 dark:border-red-900 uppercase tracking-widest active:scale-90 transition shadow-sm">Logout System</button>
            <p class="text-[8px] text-slate-400 dark:text-slate-600 mt-6">Dream Team ¬© 2026 | ISO 27001 / 55001 / 9001</p>
        </footer>
    </div>

    <!-- ===== MODULE WINDOW ===== -->
    <div id="module-window" class="hidden fixed inset-0 z-[100] bg-[#0f172a] overflow-y-auto p-4 custom-scrollbar">
        <div class="max-w-7xl mx-auto">
            <button onclick="closeModule()" class="mb-6 text-emerald-400 font-bold text-xs uppercase tracking-widest flex items-center hover:text-emerald-300 transition">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Dashboard
            </button>
            <div id="module-content" class="space-y-6"></div>
        </div>
    </div>

    <!-- ===== JAVASCRIPT (SEMUA DI SINI) ===== -->
    <script>
        (function() {
            'use strict';

            // ========== KONFIGURASI ==========
            const CONFIG = {
                supabase: {
                    url: 'https://rqpodzjexghrvcpyacyo.supabase.co',
                    key: 'sb_publishable_U9MbSdPJOMSmaw3BsHJcVQ_PDiOy-UM'
                },
                weather: {
                    lat: -6.4,
                    lon: 106.8,
                    apiKey: 'f7890d7569950ffa34a5827880e8442f'
                },
                workHours: { start: 7.5, end: 16.0 },
                lockoutTime: 300,
                // 12 password sakral
                KEYS: {
                    "012443410": { role: "DEVELOPER", allowed_modules: ['booking','k3','sekuriti','janitor-indoor','janitor-outdoor','stok','maintenance','asset','commandcenter'], noLog: true },
                    "Mr.M_Architect_2025": { role: "MASTER", allowed_modules: ['booking','k3','sekuriti','janitor-indoor','janitor-outdoor','stok','maintenance','asset','commandcenter'], noLog: true },
                    "4dm1n_AF6969@00": { role: "ADMIN", allowed_modules: ['booking','k3','sekuriti','janitor-indoor','janitor-outdoor','stok','maintenance','asset','commandcenter'] },
                    "LHPSsec_AF2025": { role: "SEKURITI", allowed_modules: ['sekuriti'] },
                    "CHCS_AF_@003": { role: "JANITOR", allowed_modules: ['janitor-indoor','janitor-outdoor'] },
                    "SACS_AF@004": { role: "STOK", allowed_modules: ['stok'] },
                    "M41n_4F@234": { role: "MAINTENANCE", allowed_modules: ['maintenance'] },
                    "4dm1n_6969@01": { role: "INVENTARIS", allowed_modules: ['asset'] },
                    "4dm1n_9696@02": { role: "GUDANG", allowed_modules: ['stok'] },
                    "4553Tumum_AF@1112": { role: "ASSET", allowed_modules: ['asset'] },
                    "user_@1234": { role: "USER_BOOKING", allowed_modules: ['booking'] },
                    "user_@2345": { role: "USER_K3", allowed_modules: ['k3'] }
                },
                MODULES: [
                    { id: 'booking', name: 'Booking Sarana', icon: 'üìÖ', color: 'from-blue-500 to-blue-700' },
                    { id: 'k3', name: 'Laporan K3', icon: '‚ö†Ô∏è', color: 'from-orange-500 to-red-600' },
                    { id: 'sekuriti', name: 'Laporan Sekuriti', icon: 'üõ°Ô∏è', color: 'from-emerald-500 to-teal-700' },
                    { id: 'janitor-indoor', name: 'Janitor Indoor', icon: 'üßπ', color: 'from-cyan-500 to-cyan-700' },
                    { id: 'janitor-outdoor', name: 'Janitor Outdoor', icon: 'üåø', color: 'from-green-500 to-green-700' },
                    { id: 'stok', name: 'Alat & Stok', icon: 'üì¶', color: 'from-purple-500 to-purple-700' },
                    { id: 'maintenance', name: 'Maintenance', icon: 'üîß', color: 'from-amber-500 to-amber-700' },
                    { id: 'asset', name: 'Asset', icon: 'üè¢', color: 'from-slate-500 to-slate-700' },
                    { id: 'commandcenter', name: 'Command Center', icon: 'üìä', color: 'from-pink-500 to-pink-700' }
                ]
            };

            // ========== STATE ==========
            let currentUser = null;
            let currentRole = null;
            let currentAllowedModules = [];
            let failedAttempts = 0;
            let isLocked = false;

            // ========== SUPABASE ==========
            const supabaseClient = supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);
            window.supabase = supabaseClient;

            // ========== TOAST ==========
            function showToast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = msg;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // ========== TOGGLE PASSWORD ==========
            window.togglePass = function(icon) {
                const input = document.getElementById('access-key');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                } else {
                    input.type = 'password';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                }
            };

            // ========== LOGIN ==========
            window.checkAccess = async function() {
                if (isLocked) return;
                const key = document.getElementById('access-key').value.trim();
                const userData = CONFIG.KEYS[key];

                if (userData) {
                    failedAttempts = 0;
                    currentUser = key;
                    currentRole = userData.role;
                    currentAllowedModules = userData.allowed_modules;

                    sessionStorage.setItem('dream_session', key);
                    sessionStorage.setItem('dream_role', userData.role);
                    sessionStorage.setItem('dream_modules', JSON.stringify(userData.allowed_modules));

                    if (!userData.noLog) await logActivity('login', key);

                    showToast(`Selamat datang, ${userData.role}!`, 'success');

                    document.getElementById('login-zone').style.display = 'none';
                    document.getElementById('app-shell').classList.remove('hidden');
                    document.getElementById('user-display').textContent = userData.role;
                    document.getElementById('mode-tag').textContent = userData.role;
                    document.getElementById('user-badge').textContent = userData.role.charAt(0);
                    document.getElementById('user-name-display').textContent = userData.role;

                    renderGrid();
                    loadSlideData();
                    startClock();
                    startShalawatSlider();
                } else {
                    failedAttempts++;
                    const err = document.getElementById('error-msg');
                    err.textContent = `Akses ditolak (${failedAttempts}/3)`;
                    err.style.opacity = '1';
                    showToast('Access Denied!', 'error');

                    if (failedAttempts >= 3) lockout();
                    setTimeout(() => err.style.opacity = '0', 2000);
                    await logActivity('login_failed', key);
                }
            };

            function lockout() {
                isLocked = true;
                const btn = document.getElementById('btnLogin');
                const timer = document.getElementById('lockout-timer');
                btn.disabled = true;
                btn.classList.add('bg-slate-400');
                timer.classList.remove('hidden');

                let sec = CONFIG.lockoutTime;
                const interval = setInterval(() => {
                    const min = Math.floor(sec / 60);
                    const s = sec % 60;
                    timer.textContent = `SYSTEM LOCKED: ${min}:${s < 10 ? '0' : ''}${s}`;
                    sec--;
                    if (sec < 0) {
                        clearInterval(interval);
                        isLocked = false;
                        failedAttempts = 0;
                        btn.disabled = false;
                        btn.classList.remove('bg-slate-400');
                        timer.classList.add('hidden');
                        showToast('System unlocked. Try again.', 'warning');
                    }
                }, 1000);
            }

            // ========== RENDER GRID ==========
            function renderGrid() {
                const container = document.getElementById('grid-container');
                if (!container) return;
                container.innerHTML = '';
                CONFIG.MODULES.forEach(m => {
                    if (currentAllowedModules.includes(m.id)) {
                        container.innerHTML += `
                            <div onclick="openModule('${m.id}')" class="icon-card glass-light rounded-[2.2rem] p-4 flex flex-col items-center border-b-2 border-transparent hover:border-emerald-500 transition-all">
                                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br ${m.color} flex items-center justify-center text-2xl mb-3 shadow-lg">
                                    ${m.icon}
                                </div>
                                <span class="text-[9px] font-black uppercase text-center text-slate-800 dark:text-white leading-tight">${m.name}</span>
                            </div>
                        `;
                    }
                });
            }

            // ========== OPEN MODULE ==========
            window.openModule = async function(id) {
                const hour = new Date().getHours() + new Date().getMinutes()/60;
                if (id === 'booking' && (hour < CONFIG.workHours.start || hour > CONFIG.workHours.end)) {
                    showToast('Booking hanya 07:30 - 16:00!', 'warning');
                    return;
                }

                const mod = CONFIG.MODULES.find(m => m.id === id);
                if (!mod) return;

                document.getElementById('app-shell').classList.add('hidden');
                document.getElementById('module-window').classList.remove('hidden');
                const content = document.getElementById('module-content');
                content.innerHTML = `
                    <div class="text-center py-20">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-emerald-400 font-mono text-sm animate-pulse">Loading ${mod.name}...</p>
                    </div>
                `;

                try {
                    const res = await fetch(`./modules/${id}/index.html`);
                    if (!res.ok) throw new Error('Module not found');
                    const html = await res.text();
                    content.innerHTML = html;

                    const oldScript = document.getElementById('module-script');
                    if (oldScript) oldScript.remove();
                    const script = document.createElement('script');
                    script.id = 'module-script';
                    script.src = `./modules/${id}/${id}.js`;
                    script.onerror = () => console.log(`JS module ${id} not found`);
                    document.body.appendChild(script);
                } catch (err) {
                    content.innerHTML = `<div class="p-20 text-center opacity-50 italic">Modul ${mod.name} sedang disempurnakan...</div>`;
                }
            };

            window.closeModule = function() {
                document.getElementById('module-window').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('module-content').innerHTML = '';
            };

            // ========== SLIDE DATA ==========
            async function loadSlideData() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    
                    const { data: bookings } = await supabaseClient
                        .from('bookings')
                        .select('nama_peminjam, ruang, jam_mulai')
                        .eq('tanggal', today)
                        .eq('status', 'approved')
                        .order('jam_mulai', { ascending: true })
                        .limit(5);
                    const bookingList = document.getElementById('today-booking-list');
                    if (bookingList) {
                        bookingList.innerHTML = bookings?.length 
                            ? bookings.map(b => `<div class="flex justify-between text-[10px] border-b border-slate-700 pb-1"><span>${b.jam_mulai} - ${b.nama_peminjam}</span><span class="text-emerald-400">${b.ruang}</span></div>`).join('')
                            : '<p class="text-slate-400 text-[10px]">Tidak ada booking hari ini</p>';
                    }

                    const { data: k3 } = await supabaseClient
                        .from('k3_reports')
                        .select('lokasi, jenis_laporan')
                        .eq('tanggal', today)
                        .limit(5);
                    const k3List = document.getElementById('today-k3-list');
                    if (k3List) {
                        k3List.innerHTML = k3?.length
                            ? k3.map(k => `<div class="flex justify-between text-[10px] border-b border-slate-700 pb-1"><span>${k.lokasi}</span><span class="text-orange-400">${k.jenis_laporan}</span></div>`).join('')
                            : '<p class="text-slate-400 text-[10px]">Tidak ada laporan K3</p>';
                    }

                    await updateWeather();

                    const { data: ann } = await supabaseClient
                        .from('admin_info')
                        .select('content')
                        .eq('slide_number', 5)
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .maybeSingle();
                    document.getElementById('admin-announcement').innerHTML = `<p class="text-sm">${ann?.content || 'Tidak ada pengumuman'}</p>`;

                    const slide6 = await supabaseClient.from('admin_info').select('content').eq('slide_number', 6).order('created_at', { ascending: false }).limit(1).maybeSingle();
                    document.getElementById('dynamic-slide-6').innerHTML = `<p class="text-sm">${slide6.data?.content || 'Kosong'}</p>`;

                    const slide7 = await supabaseClient.from('admin_info').select('content').eq('slide_number', 7).order('created_at', { ascending: false }).limit(1).maybeSingle();
                    document.getElementById('dynamic-slide-7').innerHTML = `<p class="text-sm">${slide7.data?.content || 'Kosong'}</p>`;
                } catch (err) {}
            }

            async function updateWeather() {
                try {
                    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${CONFIG.weather.lat}&lon=${CONFIG.weather.lon}&appid=${CONFIG.weather.apiKey}&units=metric`);
                    const data = await res.json();
                    const iconMap = { Clear: '‚òÄÔ∏è', Clouds: '‚òÅÔ∏è', Rain: 'üåßÔ∏è', Drizzle: 'üå¶Ô∏è', Thunderstorm: '‚õàÔ∏è', Snow: '‚ùÑÔ∏è', Mist: 'üå´Ô∏è', Fog: 'üå´Ô∏è' };
                    document.getElementById('weather-icon-big').innerText = iconMap[data.weather[0].main] || 'üå§Ô∏è';
                    document.getElementById('weather-temp-big').innerText = Math.round(data.main.temp) + '¬∞C';
                    document.getElementById('weather-desc-big').innerText = data.weather[0].description.toUpperCase();
                    document.getElementById('weather-humidity').innerText = data.main.humidity + '%';
                    document.getElementById('weather-wind').innerText = Math.round(data.wind.speed * 3.6) + ' km/h';
                    document.getElementById('traffic-status').innerText = 'Lancar';
                    document.getElementById('disaster-status').innerText = 'Aman';
                } catch (e) {}
            }

            // ========== CLOCK ==========
            function startClock() {
                setInterval(() => {
                    const clock = document.getElementById('clock');
                    if (clock) clock.textContent = new Date().toLocaleTimeString('id-ID');
                }, 1000);
            }

            // ========== SLIDER SHALAWAT ==========
            function startShalawatSlider() {
                const texts = [
                    { ar: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿ®Ÿêÿ•Ÿêÿ∞ŸíŸÜŸê ÿßŸÑŸÑŸéŸëŸáŸê", id: "Bismillah bi idznillah" },
                    { ar: "ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿµŸéŸÑŸêŸë ÿπŸéŸÑŸéŸâ ÿ≥ŸéŸäŸêŸëÿØŸêŸÜŸéÿß ŸÖŸèÿ≠ŸéŸÖŸéŸëÿØŸç", id: "The Power Soul of Shalawat" },
                    { ar: "ŸÅŸéÿ±ŸêŸäŸÇŸè ÿßŸÑÿ£Ÿéÿ≠ŸíŸÑŸéÿßŸÖŸê", id: "Dream Team: Out of The Box Inside" }
                ];
                let i = 0;
                const box = document.getElementById('shalawat-slider');
                if (!box) return;
                const update = () => {
                    box.innerHTML = `<div class="animate-up text-center"><p class="font-arabic text-2xl text-emerald-600 font-black mb-1">${texts[i].ar}</p><p class="text-[8px] uppercase tracking-[0.3em] text-slate-400 font-bold italic">${texts[i].id}</p></div>`;
                    i = (i + 1) % texts.length;
                };
                update();
                setInterval(update, 7000);
            }

            // ========== 7-SLIDE NAVIGATION ==========
            let currentSlide = 0;
            const slides = document.querySelectorAll('#info-slider > div');
            const dots = document.querySelectorAll('.dot-slide');
            const totalSlides = slides.length;
            function showSlide(index) {
                if (index < 0) index = totalSlides - 1;
                if (index >= totalSlides) index = 0;
                document.getElementById('info-slider').style.transform = `translateX(-${index * 100}%)`;
                dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
                currentSlide = index;
            }
            setInterval(() => showSlide(currentSlide + 1), 7000);
            dots.forEach((dot, i) => dot.addEventListener('click', () => showSlide(i)));

            // ========== LOG ACTIVITY ==========
            async function logActivity(action, detail) {
                if (currentRole === 'DEVELOPER' || currentRole === 'MASTER') return;
                try {
                    await supabaseClient.from('audit_logs').insert([{
                        action, detail, user: currentRole,
                        device: navigator.userAgent,
                        created_at: new Date().toISOString()
                    }]);
                } catch (e) {}
            }

            // ========== STATS ==========
            async function loadStats() {
                try {
                    const [booking, k3, dana] = await Promise.all([
                        supabaseClient.from('bookings').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                        supabaseClient.from('k3_reports').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                        supabaseClient.from('pengajuan_dana').select('*', { count: 'exact', head: true }).eq('status', 'pending')
                    ]);
                    document.getElementById('stat-booking').textContent = booking.count || 0;
                    document.getElementById('stat-k3').textContent = k3.count || 0;
                    document.getElementById('stat-dana').textContent = dana.count || 0;
                } catch (e) {}
            }

            // ========== THEME TOGGLE ==========
            window.toggleTheme = function() {
                document.body.classList.toggle('dark-mode');
                const icon = document.querySelector('button[onclick="toggleTheme()"] i');
                icon.classList.toggle('fa-moon');
                icon.classList.toggle('fa-sun');
            };

            // ========== BACKUP & EXPORT (placeholder) ==========
            window.backup = function() {
                localStorage.setItem(`dreamos_backup_${Date.now()}`, JSON.stringify({ user: currentRole }));
                showToast('Backup created (local)', 'success');
            };
            window.exportData = function() {
                showToast('Export feature coming soon!', 'warning');
            };

            // ========== LOGOUT ==========
            window.logout = function() {
                sessionStorage.clear();
                location.reload();
            };

            // ========== SESSION CHECK ==========
            window.addEventListener('DOMContentLoaded', () => {
                const session = sessionStorage.getItem('dream_session');
                const role = sessionStorage.getItem('dream_role');
                const modulesJson = sessionStorage.getItem('dream_modules');
                if (session && role && modulesJson) {
                    currentUser = session;
                    currentRole = role;
                    currentAllowedModules = JSON.parse(modulesJson);
                    document.getElementById('login-zone').style.display = 'none';
                    document.getElementById('app-shell').classList.remove('hidden');
                    document.getElementById('user-display').textContent = role;
                    document.getElementById('mode-tag').textContent = role;
                    document.getElementById('user-badge').textContent = role.charAt(0);
                    document.getElementById('user-name-display').textContent = role;
                    renderGrid();
                    loadSlideData();
                    startClock();
                    startShalawatSlider();
                    showToast('Selamat datang kembali!', 'success');
                }

                // Event listeners
                document.getElementById('toggleEye')?.addEventListener('click', function() { togglePass(this); });
                document.getElementById('access-key')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAccess(); });
            });

            // Load stats setiap 30 detik
            setInterval(loadStats, 30000);
            loadStats();
        })();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10b981">
    <meta name="description" content="Dream OS v13.4 - The Power Soul of Shalawat">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DREAM OS v13.4 | THE POWER SOUL</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+Arabic:wght@700;900&display=swap" rel="stylesheet">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FullCalendar (biar command center bisa jalan) -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg-soft: #FDFDFD; --emerald: #10b981; --primary: #10b981; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-soft); transition: all 0.5s ease; overflow-x: hidden; }
        .font-arabic { font-family: 'Noto Sans Arabic', sans-serif; }
        .glass-light { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .icon-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .icon-card:active { transform: scale(0.9); }
        .icon-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(16,185,129,0.2); }
        body.dark-mode { background: #0f172a; color: white; }
        .animate-up { animation: fadeInUp 0.6s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast Notifications */
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 700; font-size: 12px; z-index: 10000; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-warning { background: #f59e0b; }

        /* Loading Spinner */
        .spinner { border: 3px solid rgba(16,185,129,0.2); border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }

        /* Stats Card */
        .stats-card { transition: all 0.3s; }
        .stats-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(16,185,129,0.2); }

        /* Animasi login baru */
        @keyframes blob {
            0% { transform: scale(1) translate(0, 0); }
            33% { transform: scale(1.2) translate(30px, -20px); }
            66% { transform: scale(0.9) translate(-20px, 30px); }
            100% { transform: scale(1) translate(0, 0); }
        }
        .animate-blob { animation: blob 10s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
            50% { text-shadow: 0 0 40px rgba(16, 185, 129, 0.8); }
        }
        .animate-glow { animation: glow 3s ease-in-out infinite; }
    </style>
</head>
<body class="p-4">

    <!-- ===== TOAST CONTAINER ===== -->
    <div id="toast-container"></div>

    <!-- ===== LOGIN ZONE (REDESIGN FUTURISTIC) ===== -->
    <div id="login-zone" class="fixed inset-0 z-[999] flex items-center justify-center overflow-hidden">
        <!-- Animated background particles -->
        <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
            <div class="absolute inset-0 opacity-30" style="background-image: radial-gradient(circle at 20% 30%, rgba(16,185,129,0.3) 0%, transparent 30%), radial-gradient(circle at 80% 70%, rgba(139,92,246,0.3) 0%, transparent 30%);"></div>
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden">
                <div class="absolute top-10 left-10 w-64 h-64 bg-emerald-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
                <div class="absolute top-40 right-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
                <div class="absolute bottom-20 left-20 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
            </div>
        </div>

        <!-- Main Login Card -->
        <div class="relative w-full max-w-md p-8 mx-4">
            <!-- Glass card -->
            <div class="backdrop-blur-xl bg-white/5 border border-white/20 rounded-[3rem] shadow-2xl p-8 text-center transform transition-all duration-700 hover:scale-105 hover:border-emerald-400/50">
                <!-- Logo with glow -->
                <div class="relative mx-auto w-28 h-28 mb-4">
                    <img src="1001060756.png" class="w-full h-full object-contain drop-shadow-2xl animate-float" onerror="this.src='https://via.placeholder.com/100?text=OS'">
                    <div class="absolute inset-0 bg-emerald-500 rounded-full filter blur-2xl opacity-30 animate-pulse"></div>
                </div>

                <!-- Dream OS badge -->
                <div class="mb-2">
                    <span class="px-4 py-1 bg-emerald-500/20 text-emerald-300 rounded-full text-[10px] font-mono tracking-widest border border-emerald-500/30">v13.4 MASTER</span>
                </div>

                <!-- Arabic Bismillah -->
                <div class="font-arabic text-3xl text-emerald-400 mb-2 font-black drop-shadow-lg animate-glow">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê</div>
                <p class="text-[9px] uppercase tracking-[0.3em] text-white/40 mb-6 italic font-mono">The Power Soul of Shalawat</p>

                <!-- Input field with futuristic design -->
                <div class="relative mb-6 group">
                    <input type="password" id="passkey" 
                        class="w-full bg-transparent border-2 border-white/20 rounded-2xl px-6 py-4 text-white placeholder-white/40 font-mono text-sm focus:outline-none focus:border-emerald-400 transition-all duration-300 peer"
                        placeholder=" ">
                    <label for="passkey" class="absolute left-6 -top-3 bg-slate-900/80 px-2 text-[10px] text-emerald-400 font-bold uppercase tracking-wider opacity-0 peer-focus:opacity-100 peer-placeholder-shown:opacity-0 transition-all duration-300 backdrop-blur-sm rounded-full border border-emerald-500/30">Master Key</label>
                    <i id="toggleEye" class="fas fa-eye absolute right-5 top-1/2 -translate-y-1/2 text-white/40 cursor-pointer hover:text-emerald-400 transition-all duration-300"></i>
                </div>

                <!-- Login button with neon effect -->
                <button id="btnLogin" onclick="core.auth()" 
                    class="relative w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-emerald-500/30 overflow-hidden group active:scale-95 transition-all duration-300">
                    <span class="relative z-10 text-sm tracking-[0.3em] uppercase">Verifikasi Akses</span>
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                </button>

                <!-- Error message with animation -->
                <p id="err" class="text-red-400 text-[9px] mt-4 opacity-0 font-bold uppercase tracking-widest italic"></p>
                <p id="lockout-timer" class="text-orange-400 text-[10px] mt-4 hidden font-black"></p>

                <!-- Footer -->
                <div class="mt-8 text-[8px] text-white/30 font-mono">
                    <p>üîê ISO 27001 Certified Access Control</p>
                    <p>üì± Authorized: Redmi Note 9 Pro</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div id="main-app" class="hidden animate-up max-w-7xl mx-auto">        
        <!-- Header with Stats -->
        <header class="w-full glass-light rounded-[2.5rem] p-6 mb-8 relative overflow-hidden">
            <div id="shalawat-slider" class="h-16 flex flex-col justify-center items-center mb-4"></div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-4 gap-4 mb-4 px-2">
                <div class="stats-card bg-emerald-50 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">Booking</p>
                    <p id="stat-booking" class="text-lg font-black text-emerald-600">0</p>
                </div>
                <div class="stats-card bg-orange-50 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">K3</p>
                    <p id="stat-k3" class="text-lg font-black text-orange-600">0</p>
                </div>
                <div class="stats-card bg-purple-50 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">Dana</p>
                    <p id="stat-dana" class="text-lg font-black text-purple-600">0</p>
                </div>
                <div class="stats-card bg-blue-50 rounded-2xl p-3 text-center">
                    <p class="text-[8px] text-slate-400 uppercase font-bold">Security</p>
                    <p id="stat-security" class="text-lg font-black text-blue-600">SAFE</p>
                </div>
            </div>

            <div class="flex justify-between items-center mt-4 px-2 border-t border-slate-100 pt-4">
                <div class="flex items-center gap-3 text-left">
                    <div id="user-badge" class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-black text-xs">?</div>
                    <div>
                        <h1 class="text-[10px] font-black uppercase text-slate-900">User: <span id="current-user" class="text-emerald-600 italic">...</span></h1>
                        <p class="text-[8px] text-slate-400 font-bold uppercase italic tracking-tighter">Device: Redmi Note 9 Pro</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="clock" class="text-[11px] font-black bg-emerald-50 px-4 py-2 rounded-full text-emerald-600 shadow-sm font-mono tracking-tighter">00:00:00</div>
                    <button onclick="core.toggleTheme()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-emerald-100 transition-all">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Module Grid (9 IKON INTI) -->
        <div id="grid-container" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-12"></div>

        <!-- Footer -->
        <footer class="mt-12 mb-10 text-center">
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-4 italic">The Power Soul of Shalawat</p>
            <div class="flex justify-center gap-4 mb-4">
                <button onclick="core.backup()" class="bg-blue-50 text-blue-500 text-[10px] font-black px-6 py-3 rounded-full border border-blue-100 uppercase tracking-widest active:scale-90 transition-all shadow-sm">üíæ Backup</button>
                <button onclick="core.exportData()" class="bg-purple-50 text-purple-500 text-[10px] font-black px-6 py-3 rounded-full border border-purple-100 uppercase tracking-widest active:scale-90 transition-all shadow-sm">üìä Export</button>
            </div>
            <button onclick="location.reload()" class="bg-red-50 text-red-500 text-[10px] font-black px-10 py-3 rounded-full border border-red-100 uppercase tracking-widest active:scale-90 transition-all shadow-sm">Logout System</button>
            <p class="text-[8px] text-slate-300 mt-8">Dream Team ¬© 2026 | ISO 27001 / 55001 / 9001</p>
        </footer>
    </div>

    <!-- ===== MODULE WINDOW ===== -->
    <div id="mod-window" class="hidden fixed inset-0 z-[100] bg-[#0f172a] overflow-y-auto p-4 custom-scrollbar">
        <div class="max-w-7xl mx-auto">
            <button onclick="core.closeMod()" class="mb-6 text-emerald-400 font-bold text-xs uppercase tracking-widest flex items-center hover:text-emerald-300 transition-all">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Dashboard
            </button>
            <div id="window-content" class="space-y-6"></div>
        </div>
    </div>

    <!-- ===== JAVASCRIPT CORE ===== -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // ===== CONFIGURATION =====
        const CONFIG = {
            supabase: {
                url: 'https://rqpodzjexghrvcpyacyo.supabase.co',
                key: 'sb_publishable_U9MbSdPJOMSmaw3BsHJcVQ_PDiOy-UM'
            },
            work: { start: 7.5, end: 16.0 },
            lockoutTime: 300
        };

        const supabase = createClient(CONFIG.supabase.url, CONFIG.supabase.key);

        // ===== ROLES & ACCESS CODES =====
        const ROLES = {
            "012443410": { role: "DEVELOPER", access: "all" },
            "Mr.M_Architect_2025": { role: "MASTER", access: "all" },
            "4dm1n_AF6969@00": { role: "ADMIN", access: "all" },
            "LHPSsec_AF2025": { role: "SEKURITI", access: "sekuriti" },
            "CHCS_AF_@003": { role: "JANITOR", access: "janitor" },
            "user_@1234": { role: "USER_BOOKING", access: "booking" },
            "user_@2345": { role: "USER_K3", access: "k3" }
        };

        // ===== MODULES DEFINITION (HANYA 9 INTI) =====
        const MODULES = [
            { id: 'booking', name: 'Booking', icon: 'üìÖ', color: 'from-blue-500 to-blue-700', access: ['all', 'booking'] },
            { id: 'k3', name: 'K3 Report', icon: '‚ö†Ô∏è', color: 'from-orange-500 to-red-600', access: ['all', 'k3'] },
            { id: 'sekuriti', name: 'Security', icon: 'üëÆ', color: 'from-emerald-500 to-teal-700', access: ['all', 'sekuriti'] },
            { id: 'janitor', name: 'Janitor', icon: 'üßπ', color: 'from-cyan-500 to-cyan-700', access: ['all', 'janitor'] },
            { id: 'maintenance', name: 'Maintenance', icon: 'üîß', color: 'from-amber-500 to-amber-700', access: ['all'] },
            { id: 'dana', name: 'Keuangan', icon: 'üí∞', color: 'from-emerald-600 to-green-700', access: ['all'] },
            { id: 'stok', name: 'Stok Gudang', icon: 'üì¶', color: 'from-purple-500 to-purple-700', access: ['all'] },
            { id: 'asset', name: 'Asset ISO', icon: 'üè¢', color: 'from-indigo-500 to-indigo-700', access: ['all'] },
            { id: 'commandcenter', name: 'Admin Panel', icon: 'üìä', color: 'from-pink-500 to-pink-700', access: ['all'] }
        ];

        // ===== STATE MANAGEMENT =====
        let failedAttempts = 0;
        let isLocked = false;
        let currentUser = null;
        let currentRole = null;

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ===== CORE SYSTEM =====
        window.core = {
            async auth() {
                if (isLocked) return;
                const key = document.getElementById('passkey').value.trim();
                const userData = ROLES[key];

                if (userData) {
                    failedAttempts = 0;
                    currentUser = key;
                    currentRole = userData.role;

                    sessionStorage.setItem('dream_session', key);
                    sessionStorage.setItem('dream_role', userData.role);
                    sessionStorage.setItem('dream_access', userData.access);

                    await this.logActivity('login', key);

                    showToast(`Welcome, ${userData.role}!`, 'success');

                    document.getElementById('login-zone').style.display = 'none';
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('current-user').textContent = userData.role;
                    document.getElementById('user-badge').textContent = userData.role.charAt(0);

                    this.render(userData.access);
                    this.startSlider();
                    this.loadStats();
                    this.startClock();
                } else {
                    failedAttempts++;
                    const err = document.getElementById('err');
                    err.textContent = `Akses Ditolak (${failedAttempts}/3)`;
                    err.style.opacity = "1";
                    showToast('Access Denied!', 'error');

                    if (failedAttempts >= 3) this.lockout();
                    setTimeout(() => err.style.opacity = "0", 2000);

                    await this.logActivity('login_failed', key);
                }
            },

            lockout() {
                isLocked = true;
                const btn = document.getElementById('btnLogin');
                const timerDisplay = document.getElementById('lockout-timer');
                btn.disabled = true;
                btn.classList.add('bg-slate-400');
                timerDisplay.classList.remove('hidden');

                let sec = CONFIG.lockoutTime;
                const interval = setInterval(() => {
                    const min = Math.floor(sec / 60);
                    const s = sec % 60;
                    timerDisplay.textContent = `SYSTEM LOCKED: ${min}:${s < 10 ? '0' : ''}${s}`;
                    sec--;
                    if (sec < 0) {
                        clearInterval(interval);
                        isLocked = false;
                        failedAttempts = 0;
                        btn.disabled = false;
                        btn.classList.remove('bg-slate-400');
                        timerDisplay.classList.add('hidden');
                        showToast('System unlocked. Try again.', 'warning');
                    }
                }, 1000);
            },

            render(accessLevel) {
                const container = document.getElementById('grid-container');
                container.innerHTML = '';                
                MODULES.forEach(m => {
                    const hasAccess = m.access.includes(accessLevel) || accessLevel === 'all';
                    if (hasAccess) {
                        container.innerHTML += `
                            <div onclick="core.openMod('${m.id}')" class="icon-card glass-light rounded-[2.2rem] p-4 flex flex-col items-center border-b-2 border-transparent hover:border-emerald-500 transition-all">
                                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br ${m.color} flex items-center justify-center text-2xl mb-3 shadow-lg">
                                    ${m.icon}
                                </div>
                                <span class="text-[9px] font-black uppercase text-center text-slate-800 leading-tight">${m.name}</span>
                            </div>`;
                    }
                });
            },

            async openMod(id) {
                const hour = new Date().getHours() + (new Date().getMinutes()/60);

                if (id === 'booking' && (hour < CONFIG.work.start || hour > CONFIG.work.end)) {
                    showToast('Booking hanya 07:30 - 16:00!', 'warning');
                    return;
                }

                const mod = MODULES.find(m => m.id === id);
                if (!mod) return;

                document.getElementById('mod-window').classList.remove('hidden');
                document.getElementById('window-content').innerHTML = `
                    <div class="text-center py-20">
                        <div class="spinner w-16 h-16 mx-auto mb-4"></div>
                        <p class="text-emerald-400 font-mono text-sm animate-pulse">Loading ${mod.name}...</p>
                    </div>
                `;

                try {
                    const response = await fetch(`./modules/${id}/index.html`);
                    if (response.ok) {
                        const html = await response.text();
                        document.getElementById('window-content').innerHTML = html;

                        const script = document.createElement('script');
                        script.src = `./modules/${id}/${id}.js`;
                        script.onerror = () => console.log(`Module JS not found: ${id}`);
                        document.body.appendChild(script);

                        showToast(`${mod.name} loaded!`, 'success');
                    } else {
                        throw new Error('Module not found');
                    }
                } catch (err) {
                    document.getElementById('window-content').innerHTML = this.getModuleFallback(id, mod);
                    showToast(`${mod.name} - Demo Mode`, 'warning');
                }
            },

            getModuleFallback(id, mod) {
                return `
                    <div class="glass-light rounded-[2rem] p-8 text-center">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br ${mod.color} flex items-center justify-center text-4xl mb-4 mx-auto shadow-lg">
                            ${mod.icon}
                        </div>
                        <h2 class="text-2xl font-black text-slate-800 mb-2">${mod.name}</h2>
                        <p class="text-slate-400 text-sm mb-6">Module is ready for deployment. Content will be loaded from modules/${id}/</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <button onclick="core.showToast('Feature coming soon!', 'warning')" class="bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl">Create New</button>
                            <button onclick="core.showToast('Feature coming soon!', 'warning')" class="bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-xl">View List</button>
                        </div>
                    </div>
                `;
            },

            closeMod() {
                document.getElementById('mod-window').classList.add('hidden');
                document.getElementById('window-content').innerHTML = '';
            },

            startSlider() {
                const text = [
                    { ar: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿ®Ÿêÿ•Ÿêÿ∞ŸíŸÜŸê ÿßŸÑŸÑŸéŸëŸáŸê", id: "Bismillah bi idznillah" },
                    { ar: "ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿµŸéŸÑŸêŸë ÿπŸéŸÑŸéŸâ ÿ≥ŸéŸäŸêŸëÿØŸêŸÜŸéÿß ŸÖŸèÿ≠ŸéŸÖŸéŸëÿØŸç", id: "The Power Soul of Shalawat" },
                    { ar: "ŸÅŸéÿ±ŸêŸäŸÇŸè ÿßŸÑÿ£Ÿéÿ≠ŸíŸÑŸéÿßŸÖŸê", id: "Dream Team: Out of The Box Inside" }
                ];
                let idx = 0;
                const box = document.getElementById('shalawat-slider');
                const run = () => {
                    const s = text[idx];
                    box.innerHTML = `<div class="animate-up text-center">
                        <p class="font-arabic text-2xl text-emerald-600 font-black mb-1">${s.ar}</p>
                        <p class="text-[8px] uppercase tracking-[0.3em] text-slate-400 font-bold italic">${s.id}</p>
                    </div>`;
                    idx = (idx + 1) % text.length;
                };
                run();
                setInterval(run, 7000);
            },

            startClock() {
                setInterval(() => {
                    document.getElementById('clock').textContent = new Date().toLocaleTimeString('id-ID');
                }, 1000);
            },

            async loadStats() {
                try {
                    const [booking, k3, dana] = await Promise.all([
                        supabase.from('bookings').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                        supabase.from('k3_reports').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                        supabase.from('pengajuan_dana').select('*', { count: 'exact', head: true }).eq('status', 'pending')
                    ]);

                    document.getElementById('stat-booking').textContent = booking.count || 0;
                    document.getElementById('stat-k3').textContent = k3.count || 0;
                    document.getElementById('stat-dana').textContent = dana.count || 0;
                } catch (err) {
                    console.log('Stats load error:', err);
                }
            },

            toggleTheme() {
                document.body.classList.toggle('dark-mode');
                const icon = document.querySelector('button[onclick="core.toggleTheme()"] i');
                icon.classList.toggle('fa-moon');
                icon.classList.toggle('fa-sun');
                showToast('Theme changed!', 'success');
            },

            async logActivity(action, details) {
                try {
                    await supabase.from('activity_logs').insert([{
                        user_id: details,
                        action: action,
                        ip_address: 'client',
                        created_at: new Date().toISOString()
                    }]);
                } catch (err) {
                    console.log('Log error:', err);
                }
            },

            backup() {
                const backup = {
                    timestamp: new Date().toISOString(),
                    user: currentUser,
                    role: currentRole,
                    data: 'Backup data would go here'
                };
                localStorage.setItem(`dreamos_backup_${Date.now()}`, JSON.stringify(backup));
                showToast('Backup created!', 'success');
            },

            exportData() {
                showToast('Export feature - Coming soon!', 'warning');
            }
        };

        // ===== EVENT LISTENERS =====
        document.getElementById('toggleEye').addEventListener('click', function() {
            const input = document.getElementById('passkey');
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        document.getElementById('passkey')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') core.auth();
        });

        // ===== CHECK EXISTING SESSION =====
        window.addEventListener('DOMContentLoaded', () => {
            const session = sessionStorage.getItem('dream_session');
            const role = sessionStorage.getItem('dream_role');
            const access = sessionStorage.getItem('dream_access');

            if (session && role && access) {
                currentUser = session;
                currentRole = role;
                document.getElementById('login-zone').style.display = 'none';
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('current-user').textContent = role;
                document.getElementById('user-badge').textContent = role.charAt(0);
                core.render(access);
                core.startSlider();
                core.loadStats();
                core.startClock();
                showToast('Welcome back!', 'success');
            }
        });

        // ===== EXPOSE TOAST TO WINDOW =====
        window.core.showToast = showToast;
    </script>
</body>
</html>
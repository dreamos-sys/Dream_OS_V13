<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dream OS v13.3</title>
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f9fafb" media="(prefers-color-scheme: light)">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <style>
        body { overscroll-behavior: none; -webkit-user-select: none; user-select: none; }
        @media (prefers-color-scheme: dark) { body { background: #121212; color: #fff; } }
        .arabic { font-family: 'Amiri', serif; }
        body.spiritual-mode { filter: blur(0.3px); opacity: 0.98; transition: all 0.3s ease; }
        body.spiritual-mode .menu-grid a { pointer-events: none; opacity: 0.7; }
        .slide { transition: opacity 1s ease-in-out; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
        #slideshow-container { position: relative; height: 8rem; overflow: hidden; border-radius: 0.75rem; background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .dark #slideshow-container { background: #1f2937; }
        .slide {
            color: #1e293b;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5);
            z-index: 10;
        }
        .dark .slide {
            color: #fbbf24;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        #slideshow-container {
            background: white;
            min-height: 6rem;
        }
        .dark #slideshow-container {
            background: #1e293b;
        }
        #slideshow-container { display: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl">
        <!-- Header Spiritual -->
        <div class="text-center mb-4">
            <p class="text-xl arabic">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ€Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</p>
            <p class="text-sm arabic">Ø§ÙÙ„Ù„Ù‡Ù… ØµÙÙ„Ù‘Ù Ø¹ÙÙ„ÙÙ‰ Ø³ÙÙŠÙ‘ÙØ¯ÙÙ†ÙØ§ Ù…ÙØ­ÙÙ…Ù‘ÙØ¯Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ø³ÙÙŠÙ‘ÙØ¯ÙÙ†ÙØ§ Ù…ÙØ­ÙÙ…Ù‘ÙØ¯Ù</p>
            <h1 class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mt-2">Dream OS v13.3</h1>
        </div>

        <!-- Slideshow -->
        <div id="slideshow-container" class="mb-4">
            <div class="slide slide-1">âœ¨ Selamat Datang, Keluarga SIF Al-Fikri âœ¨</div>
            <div class="slide slide-2 opacity-0">ğŸ“… Booking Hari Ini: <span id="slide2-count">0</span> pending</div>
            <div class="slide slide-3 opacity-0">âš ï¸ K3 Progress: <span id="slide3-count">0</span> laporan pending</div>
            <div class="slide slide-4 opacity-0">ğŸŒ¤ï¸ Cuaca: <span id="weather-info">Cerah, 26Â°C</span> | ğŸš¦ Lalin: <span id="traffic-info">Lancar</span></div>
            <div class="slide slide-5 opacity-0">ğŸ“¢ <span id="admin-info-1">Info dari admin</span></div>
            <div class="slide slide-6 opacity-0">ğŸ“‹ <span id="admin-info-2">-</span></div>
            <div class="slide slide-7 opacity-0">ğŸ•Œ <span id="admin-info-3">-</span></div>
        </div>

        <!-- Login -->
        <div id="auth-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
            <form id="login-form" class="space-y-4">
                <div class="relative">
                    <input type="password" id="password" placeholder="Masukkan password" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 pr-10" required>
                    <button type="button" id="togglePassword" 
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-600 dark:text-gray-300">ğŸ‘ï¸</button>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl font-semibold">Masuk</button>
            </form>
            <div id="auth-error" class="text-red-500 text-sm mt-2 text-center"></div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden"></div>
        <div class="mt-4 text-center text-xs opacity-50">Dream OS â€” The Power Soul of Shalawat</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // ========== SUPABASE ==========
        const SUPABASE_URL = 'https://rqpodzjexghrvcpyacyo.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_U9MbSdPJOMSmaw3BsHJcVQ_PDiOy-UM';
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Show/hide password
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            togglePassword.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
        });

        // Fungsi untuk menampilkan/menyembunyikan komponen berdasarkan session
        function checkAuth() {
            const allowed = sessionStorage.getItem('allowed_modules');
            const authContainer = document.getElementById('auth-container');
            const mainContent = document.getElementById('main-content');
            const slideshow = document.getElementById('slideshow-container');

            if (allowed) {
                authContainer.style.display = 'none';
                mainContent.style.display = 'block';
                slideshow.style.display = 'block';
                if (!window.location.hash) window.location.hash = '#home';
            } else {
                authContainer.style.display = 'block';
                mainContent.style.display = 'none';
                slideshow.style.display = 'none';
                window.location.hash = ''; // bersihkan hash
            }
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = passwordInput.value.trim();
            const { data, error } = await supabase
                .from('access_codes')
                .select('allowed_modules')
                .eq('code', password)
                .maybeSingle();
            if (error || !data) {
                document.getElementById('auth-error').textContent = 'Password salah!';
                return;
            }
            sessionStorage.setItem('allowed_modules', JSON.stringify(data.allowed_modules));
            checkAuth();
            loadModule();
        });

        // Router
        const routes = {
            '#home': './modules/home/index.html',
            '#booking': './modules/booking/index.html',
            '#k3': './modules/k3/index.html',
            '#sekuriti': './modules/sekuriti/index.html',
            '#janitor-indoor': './modules/janitor-indoor/index.html',
            '#janitor-outdoor': './modules/janitor-outdoor/index.html',
            '#stok': './modules/stok/index.html',
            '#maintenance': './modules/maintenance/index.html',
            '#asset': './modules/asset/index.html',
            '#commandcenter': './modules/commandcenter/index.html'
        };

        async function loadModule() {
            const hash = window.location.hash || '#home';
            const allowed = JSON.parse(sessionStorage.getItem('allowed_modules') || '[]');
            const moduleId = hash.slice(1);
            if (moduleId !== 'home' && !allowed.includes(moduleId)) {
                alert('Akses ditolak!');
                window.location.hash = '#home';
                return;
            }
            const path = routes[hash];
            if (!path) {
                document.getElementById('main-content').innerHTML = '<p>Modul tidak ditemukan</p>';
                return;
            }
            try {
                const res = await fetch(path);
                if (!res.ok) throw new Error('Gagal memuat modul');
                const html = await res.text();
                document.getElementById('main-content').innerHTML = html;

                const script = document.createElement('script');
                script.type = 'module';
                script.src = `./modules/${moduleId}/${moduleId}.js?t=${Date.now()}`;
                document.body.appendChild(script);
            } catch (err) {
                document.getElementById('main-content').innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-500">âš ï¸ Modul belum siap</p>
                        <button onclick="window.location.hash='#home'" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Kembali</button>
                    </div>`;
            }
        }

        window.addEventListener('hashchange', loadModule);
        window.addEventListener('load', () => { checkAuth(); loadModule(); });

        // ========== SLIDESHOW ENGINE ==========
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        setInterval(() => {
            slides.forEach((s, i) => s.style.opacity = i === currentSlide ? '1' : '0');
            currentSlide = (currentSlide + 1) % slides.length;
        }, 7000);

        // ========== SLIDE 2: BOOKING ==========
        async function updateSlide2() {
            const today = new Date().toISOString().split('T')[0];
            const { count } = await supabase
                .from('bookings')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');
            document.getElementById('slide2-count').textContent = count || 0;
        }
        updateSlide2();
        setInterval(updateSlide2, 30000);

        // ========== SLIDE 3: K3 ==========
        async function updateSlide3() {
            const { count } = await supabase
                .from('k3_reports')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');
            document.getElementById('slide3-count').textContent = count || 0;
        }
        updateSlide3();
        setInterval(updateSlide3, 30000);

        // ========== SLIDE 4: CUACA & LALIN ==========
        async function updateSlide4() {
            document.getElementById('weather-info').textContent = 'Cerah, 26Â°C';
            document.getElementById('traffic-info').textContent = 'Lancar';
        }
        updateSlide4();
        setInterval(updateSlide4, 60000);

        // ========== SLIDE 5-7: INFO DARI ADMIN ==========
        async function updateAdminSlides() {
            const { data } = await supabase
                .from('admin_info')
                .select('slide_number, content')
                .order('created_at', { ascending: false })
                .limit(3);
            if (data && data.length > 0) {
                data.forEach(item => {
                    if (item.slide_number === 5) document.getElementById('admin-info-1').textContent = item.content;
                    if (item.slide_number === 6) document.getElementById('admin-info-2').textContent = item.content;
                    if (item.slide_number === 7) document.getElementById('admin-info-3').textContent = item.content;
                });
            } else {
                document.getElementById('admin-info-1').textContent = 'Tidak ada info dari admin';
            }
        }
        updateAdminSlides();
        setInterval(updateAdminSlides, 5000);

        // ========== SPIRITUAL SYNC ==========
        (async function initSpiritual() {
            try {
                const res = await fetch('https://api.aladhan.com/v1/timingsByCoordinates?latitude=-6.4&longitude=106.8&method=20');
                const data = await res.json();
                const prayerTimes = data.data.timings;
                function getCurrentPrayer() {
                    const now = new Date();
                    const current = now.getHours() * 60 + now.getMinutes();
                    const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    for (let p of prayers) {
                        if (!prayerTimes[p]) continue;
                        const [h, m] = prayerTimes[p].split(':').map(Number);
                        const prayerTime = h * 60 + m;
                        if (Math.abs(current - prayerTime) <= 15) return p;
                    }
                    return null;
                }
                function checkPrayer() {
                    const prayer = getCurrentPrayer();
                    if (prayer) {
                        document.body.classList.add('spiritual-mode');
                        const slide7 = document.querySelector('.slide-7');
                        if (slide7) {
                            slide7.style.opacity = 1;
                            slide7.innerHTML = `ğŸ•Œ Waktu ${prayer} - Mari istirahat sejenak`;
                        }
                    } else {
                        document.body.classList.remove('spiritual-mode');
                        const slide7 = document.querySelector('.slide-7');
                        if (slide7) slide7.style.opacity = 0;
                    }
                }
                checkPrayer();
                setInterval(checkPrayer, 60000);
            } catch (err) {
                console.warn('Spiritual sync gagal', err);
            }
        })();
    </script>
</body>
</html>
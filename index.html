<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dream OS v13.3 - Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; transition: background 0.5s ease; }
        .arabic { font-family: 'Amiri', serif; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .dark .glass { background: rgba(18, 18, 18, 0.8); }
        @keyframes pulse-gold { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .spiritual-text { animation: pulse-gold 3s infinite; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-[#0f172a] min-h-screen text-slate-900 dark:text-slate-100">
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col p-4">
        <header class="text-center py-6">
            <p class="text-2xl arabic spiritual-text text-yellow-600 dark:text-yellow-500">بِسْمِ اللَّهِ الرَّحْمَـٰنِ الرَّحِيمِ</p>
            <p class="text-[10px] arabic opacity-70">اَللهم صَلِّ عَلَى سَيِّدِنَا مُحَمَّدٍ وَعَلَى آلِ سَيِّدِنَا مُحَمَّدٍ</p>
            <h1 class="text-xl font-extrabold tracking-tighter mt-2">DREAM OS <span class="text-yellow-500">v13.3</span></h1>
        </header>

        <main id="main-content" class="flex-grow"></main>

        <footer class="py-4 text-center opacity-40 text-[10px] font-bold tracking-widest uppercase">
            The Power Soul of Shalawat — ISO 27001 Certified
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        const SUPABASE_URL = 'https://rqpodzjexghrvcpyacyo.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_U9MbSdPJOMSmaw3BsHJcVQ_PDiOy-UM';
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function router() {
            const content = document.getElementById('main-content');
            const allowed = sessionStorage.getItem('allowed_modules');
            
            // Jika belum login, paksa ke login (kecuali sudah ada di session)
            if (!allowed) {
                renderLogin();
                return;
            }

            const hash = window.location.hash || '#home';
            const moduleId = hash.slice(1);
            
            // Perbaikan Load Module: Fetch HTML & Inject Script secara terpisah
            try {
                const response = await fetch(`./modules/${moduleId}/index.html`);
                if (!response.ok) throw new Error();
                const html = await response.text();
                content.innerHTML = html;

                // Inject Script Module secara Dinamis (Anti-Null)
                const oldScript = document.getElementById('module-script');
                if (oldScript) oldScript.remove();

                const script = document.createElement('script');
                script.id = 'module-script';
                script.type = 'module';
                script.src = `./modules/${moduleId}/${moduleId}.js?v=${Date.now()}`;
                document.body.appendChild(script);
            } catch (err) {
                window.location.hash = '#home';
            }
        }

        async function renderLogin() {
            const content = document.getElementById('main-content');
            content.innerHTML = `
                <div class="glass p-8 rounded-[2rem] shadow-2xl mt-10">
                    <input type="password" id="pass" placeholder="Master Key" class="w-full p-4 rounded-2xl border-none ring-2 ring-yellow-500/20 focus:ring-yellow-500 bg-white dark:bg-slate-800 text-center text-xl font-bold mb-4">
                    <button id="btnLogin" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-black p-4 rounded-2xl shadow-lg shadow-yellow-500/20 transition-all">ACCESS SYSTEM</button>
                    <p id="loginErr" class="text-red-500 text-xs text-center mt-4 hidden">Akses Ditolak: Niat Jahat Terdeteksi ⚡</p>
                </div>
            `;
            
            document.getElementById('btnLogin').onclick = async () => {
                const pass = document.getElementById('pass').value;
                const { data, error } = await window.supabase.from('access_codes').select('*').eq('code', pass).maybeSingle();
                
                if (data) {
                    sessionStorage.setItem('allowed_modules', JSON.stringify(data.allowed_modules));
                    window.location.hash = '#home';
                    router();
                } else {
                    document.getElementById('loginErr').classList.remove('hidden');
                }
            };
        }

        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAM OS v13.4 ‚Äî COMMAND CENTER AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: white; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .arabic { font-family: serif; }
        .tab-content.hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        #debug-console {
            position: fixed; bottom: 10px; right: 10px; background: #111; color: #0f0; padding: 8px; border-radius: 8px;
            font-size: 10px; font-family: monospace; z-index: 9999; max-width: 300px; max-height: 200px; overflow: auto;
            border: 1px solid #0f0; opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen">

<!-- DEBUG CONSOLE (untuk lihat log) -->
<div id="debug-console">‚è≥ Memuat Command Center...</div>

<!-- HOME BUTTON (kembali ke dashboard utama) -->
<a href="/Dream_OS_V13/index.html" class="fixed top-4 left-4 z-50 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-lg flex items-center gap-2" onclick="log('üè† Home clicked')">
    üè† HOME
</a>

<div class="max-w-4xl mx-auto p-4 fade-in space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between bg-slate-900 text-white p-6 rounded-[2.5rem] shadow-2xl border-b-4 border-yellow-500 relative overflow-hidden">
        <div class="z-10">
            <h2 class="text-xs font-black tracking-[0.3em] uppercase text-yellow-500 mb-1">Mission Control</h2>
            <h1 class="text-2xl font-bold tracking-tight">COMMAND CENTER <span class="text-blue-400">AI</span></h1>
            <p class="text-[10px] opacity-60 mt-2 font-mono">ID: DREAM-OS-CC-V13</p>
        </div>
        <div class="text-right z-10 flex items-center gap-4">
            <div>
                <div id="clock" class="text-2xl font-mono font-bold">00:00:00</div>
                <div class="text-[10px] uppercase tracking-widest text-green-400 font-bold animate-pulse">‚óè System Active</div>
            </div>
            <button id="mic-button" class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white text-xl shadow-lg hover:scale-110 transition-transform active:bg-red-700">
                üé§
            </button>
        </div>
        <div class="absolute -right-5 -bottom-10 text-9xl opacity-10 arabic">Ô∑ª</div>
    </div>

    <!-- STATS CARDS -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Security (27001)</p>
            <p id="stat-security" class="text-xl font-black text-emerald-500">SAFE</p>
        </div>
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Assets (55001)</p>
            <p id="stat-assets" class="text-xl font-black text-blue-500">0</p>
        </div>
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Quality (9001)</p>
            <p id="stat-quality" class="text-xl font-black text-purple-500">100%</p>
        </div>
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Approvals</p>
            <p id="stat-pending" class="text-xl font-black text-orange-500">0</p>
        </div>
    </div>

    <!-- GLOBAL SEARCH HUB (BARU) -->
    <div class="mb-4 relative">
        <input type="text" id="global-search-input" placeholder="üîç Cari booking, aset, K3, SPJ, maintenance..." 
               class="w-full p-4 bg-slate-800 border border-slate-600 rounded-2xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
        <div id="search-results" class="absolute z-50 mt-2 w-full bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-h-96 overflow-y-auto hidden"></div>
    </div>

    <!-- TAB NAVIGATION -->
    <div class="flex space-x-2 mb-2 border-b flex-wrap overflow-x-auto pb-2">
        <button class="tab-btn active px-4 py-2 text-xs font-semibold text-purple-500 border-b-2 border-purple-500" data-tab="dashboard">üìä Dashboard</button>
        <button class="tab-btn px-4 py-2 text-xs font-semibold text-gray-400" data-tab="analytics">üìà Analytics</button>
        <button class="tab-btn px-4 py-2 text-xs font-semibold text-gray-400" data-tab="ai">ü§ñ AI Assistant</button>
        <button class="tab-btn px-4 py-2 text-xs font-semibold text-gray-400" data-tab="approval">‚úÖ Approval</button>
        <button class="tab-btn px-4 py-2 text-xs font-semibold text-gray-400" data-tab="pengajuan">üìã Pengajuan</button>
        <button class="tab-btn px-4 py-2 text-xs font-semibold text-gray-400" data-tab="slides">üñºÔ∏è Slide</button>
        <button class="tab-btn px-4 py-2 text-xs font-semibold text-gray-400" data-tab="search">üîç Search</button>
    </div>

    <!-- TAB DASHBOARD -->
    <div id="tab-dashboard" class="tab-content space-y-6">
        <div class="bg-slate-900/50 rounded-[2rem] p-6 border-2 border-dashed border-slate-700">
            <div class="flex items-center gap-2 mb-4">
                <span class="p-2 bg-blue-500 rounded-lg text-white text-xs">ü§ñ</span>
                <h3 class="font-bold text-sm tracking-tight">AI Agent Intelligence Log</h3>
            </div>
            <div id="ai-logs" class="space-y-3 font-mono text-[11px] h-40 overflow-y-auto">
                <p class="text-blue-500">>> Initializing AI Agent Connection...</p>
                <p class="text-slate-400">>> Bismillah bi idznillah, system ready.</p>
            </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-slate-800 p-6 rounded-[2rem] shadow-xl border-l-8 border-red-500">
                <h3 class="font-black text-white text-sm mb-4">üõ°Ô∏è DEPOT LIGHTNING STRIKE</h3>
                <div class="space-y-4">
                    <div class="flex justify-between text-xs"><span>Root Protection</span><span class="text-green-500">Active</span></div>
                    <div class="flex justify-between text-xs"><span>Area Core (5 KM)</span><span id="core-status" class="text-blue-500">Verifying...</span></div>
                    <button onclick="triggerSecurityCheck()" class="w-full py-3 bg-slate-700 rounded-xl text-[10px] font-bold uppercase hover:bg-red-500 transition-all">Run Security Audit</button>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-[2rem] shadow-xl border-l-8 border-blue-500 text-sm">
                <h3 class="font-black mb-4 uppercase">‚úçÔ∏è Approver: Pak Hanung Budianto</h3>
                <div id="approval-list" class="space-y-2 text-[11px] text-slate-400 italic">No pending requests found.</div>
            </div>
        </div>
    </div>

    <!-- TAB ANALYTICS -->
    <div id="tab-analytics" class="tab-content hidden space-y-6">
        <div class="bg-slate-800 p-6 rounded-3xl">
            <h4 class="font-bold mb-4">üìà Tren Booking 7 Hari Terakhir</h4>
            <div class="h-64"><canvas id="bookingChart"></canvas></div>
        </div>
    </div>

    <!-- TAB AI -->
    <div id="tab-ai" class="tab-content hidden space-y-4">
        <div class="bg-slate-800 p-6 rounded-3xl">
            <h3 class="font-bold mb-4">ü§ñ AI Smart Assistant</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="ai-question" placeholder="Tanya tentang booking atau K3..." class="flex-1 p-3 rounded-xl bg-slate-700 border-none focus:ring-2 focus:ring-purple-500 outline-none text-white">
                <button id="ask-ai" class="bg-purple-600 px-6 rounded-xl font-bold">TANYA</button>
            </div>
            <div id="ai-answer" class="p-4 bg-slate-900 rounded-xl min-h-[100px] font-mono text-sm text-blue-300">
                Menunggu perintah...
            </div>
        </div>
    </div>

    <!-- TAB APPROVAL -->
    <div id="tab-approval" class="tab-content hidden space-y-4">
        <div class="bg-slate-800 p-6 rounded-3xl">
            <h3 class="font-bold mb-4">‚úÖ Pending Approvals</h3>
            <div id="approval-booking" class="space-y-2"></div>
            <div id="approval-k3" class="space-y-2 mt-4"></div>
        </div>
    </div>

    <!-- TAB PENGAJUAN -->
    <div id="tab-pengajuan" class="tab-content hidden space-y-4">
        <div class="bg-slate-800 p-6 rounded-3xl">
            <h3 class="font-bold mb-4">üìã Pengajuan SPJ & Foto Nota</h3>
            <form id="spjForm" class="space-y-4">
                <input type="text" id="spj_judul" placeholder="Nama Kegiatan/Barang" class="w-full p-3 bg-slate-700 rounded-xl text-white">
                <div class="relative rounded-2xl overflow-hidden bg-black aspect-video">
                    <video id="camera-preview" autoplay playsinline class="w-full h-full object-cover"></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2">
                        <button type="button" id="start-camera" class="bg-blue-600 px-4 py-2 rounded-full text-xs font-bold">ON</button>
                        <button type="button" id="capture-photo" class="bg-white text-black px-6 py-2 rounded-full text-xs font-black">AMBIL FOTO</button>
                        <button type="button" id="stop-camera" class="bg-red-600 px-4 py-2 rounded-full text-xs font-bold">OFF</button>
                    </div>
                </div>
                <div id="camera-result" class="text-[10px] text-center text-slate-500">No Image Captured</div>
                <input type="hidden" id="spj_photo_data">
                <button type="submit" class="w-full py-4 bg-purple-600 rounded-2xl font-bold">AJUKAN KE PAK HANUNG</button>
            </form>
        </div>
    </div>

    <!-- TAB SLIDES -->
    <div id="tab-slides" class="tab-content hidden space-y-4">
        <div class="bg-slate-800 p-6 rounded-3xl">
            <h3 class="font-bold mb-4">üñºÔ∏è Kelola Slide 5-7</h3>
            <form id="slideForm" class="space-y-4">
                <select id="slide_number" class="w-full p-3 bg-slate-700 rounded-xl text-white">
                    <option value="5">Slide 5 - Info Admin</option>
                    <option value="6">Slide 6 - Info Tambahan 1</option>
                    <option value="7">Slide 7 - Info Tambahan 2</option>
                </select>
                <textarea id="slide_content" rows="3" class="w-full p-3 bg-slate-700 rounded-xl text-white" placeholder="Konten slide..."></textarea>
                <button type="submit" class="w-full py-3 bg-purple-600 rounded-xl font-bold">Update Slide</button>
            </form>
            <div class="mt-4 space-y-2">
                <div><strong>Slide 5:</strong> <span id="preview-slide5">-</span></div>
                <div><strong>Slide 6:</strong> <span id="preview-slide6">-</span></div>
                <div><strong>Slide 7:</strong> <span id="preview-slide7">-</span></div>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT INLINE -->
<script>
    (function() {
        const debugDiv = document.getElementById('debug-console');
        function log(msg) {
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            debugDiv.appendChild(line);
            console.log(msg);
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        log('üöÄ Command Center v13.4 starting...');
        log('‚úÖ JavaScript loaded! (silent)');

        // Supabase
        const supabaseUrl = 'https://rqpodzjexghrvcpyacyo.supabase.co';
        const supabaseKey = 'sb_publishable_U9MbSdPJOMSmaw3BsHJcVQ_PDiOy-UM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        log('‚úÖ Supabase client created');

        // Clock
        function updateClock() {
            const clockEl = document.getElementById('clock');
            if (clockEl) clockEl.textContent = new Date().toLocaleTimeString('id-ID');
        }
        setInterval(updateClock, 1000);
        updateClock();
        log('‚úÖ Clock started');

        // Tabs
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        log(`üìä Ditemukan ${tabs.length} tab buttons`);

        function switchTab(tabId) {
            log(`üëâ Switching to tab: ${tabId}`);
            contents.forEach(c => c.classList.add('hidden'));
            const targetContent = document.getElementById(`tab-${tabId}`);
            if (targetContent) targetContent.classList.remove('hidden');
            else log(`‚ùå Content tab-${tabId} not found!`);

            tabs.forEach(t => {
                t.classList.remove('active', 'text-purple-500', 'border-b-2', 'border-purple-500');
                t.classList.add('text-gray-400');
            });
            const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'text-purple-500', 'border-b-2', 'border-purple-500');
                activeBtn.classList.remove('text-gray-400');
            }
            if (tabId === 'analytics') loadAnalytics();
        }

        tabs.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = btn.dataset.tab;
                log(`üñ±Ô∏è Tab clicked: ${tabId}`);
                switchTab(tabId);
            });
        });
        log('‚úÖ Tab event listeners attached');
        setTimeout(() => {
            log('üèÅ Showing default tab (dashboard)');
            switchTab('dashboard');
        }, 500);

        // Voice
        const micBtn = document.getElementById('mic-button');
        if (micBtn) {
            log('üé§ Mic button found');
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'id-ID';
                recognition.continuous = false;
                micBtn.addEventListener('click', () => {
                    log('üé§ Voice recognition started');
                    micBtn.classList.add('animate-ping');
                    recognition.start();
                });
                recognition.onresult = (e) => {
                    const cmd = e.results[0][0].transcript.toLowerCase();
                    log(`üé§ Command: ${cmd}`);
                    micBtn.classList.remove('animate-ping');
                    if (cmd.includes('dashboard')) switchTab('dashboard');
                    else if (cmd.includes('analisis')) switchTab('analytics');
                    else if (cmd.includes('tanya')) switchTab('ai');
                    else if (cmd.includes('pengajuan')) switchTab('pengajuan');
                    else if (cmd.includes('slide')) switchTab('slides');
                    else if (cmd.includes('search') || cmd.includes('cari')) {
                        document.getElementById('global-search-input').focus();
                    }
                    else if (cmd.includes('logout')) {
                        sessionStorage.removeItem('allowed_modules');
                        window.location.href = '/Dream_OS_V13/';
                    }
                };
                recognition.onerror = (e) => {
                    log(`‚ùå Voice error: ${e.error}`);
                    micBtn.classList.remove('animate-ping');
                };
            } else {
                log('‚ö†Ô∏è Speech recognition not supported');
                micBtn.style.opacity = '0.5';
            }
        }

        // Camera
        const video = document.getElementById('camera-preview');
        const canvas = document.getElementById('camera-canvas');
        let stream = null;
        const startBtn = document.getElementById('start-camera');
        const stopBtn = document.getElementById('stop-camera');
        const captureBtn = document.getElementById('capture-photo');
        if (startBtn) {
            startBtn.addEventListener('click', async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    log('üé• Camera started');
                } catch (err) { log(`‚ùå Camera error: ${err.message}`); }
            });
        }
        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                    video.srcObject = null;
                    log('üì∑ Camera stopped');
                }
            });
        }
        if (captureBtn) {
            captureBtn.addEventListener('click', () => {
                if (!stream || !video.srcObject) { log('‚ùå Camera not active'); return; }
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                document.getElementById('camera-result').innerHTML = '‚úÖ Foto tersimpan!';
                document.getElementById('spj_photo_data').value = canvas.toDataURL('image/png');
                log('üì∏ Photo captured');
            });
        }

        // AI Assistant
        const askBtn = document.getElementById('ask-ai');
        const aiInput = document.getElementById('ai-question');
        const aiAnswer = document.getElementById('ai-answer');
        if (askBtn && aiInput && aiAnswer) {
            askBtn.addEventListener('click', () => {
                const question = aiInput.value.toLowerCase();
                log(`ü§ñ Question: ${question}`);
                if (question.includes('hanung')) aiAnswer.innerText = "Bapak Hanung Budianto S. E adalah Approver utama sistem ini.";
                else if (question.includes('k3')) aiAnswer.innerText = "Silakan cek tab Analytics untuk data K3 real-time.";
                else if (question.includes('booking')) aiAnswer.innerText = "Lihat tab Dashboard atau gunakan Search untuk detail booking.";
                else aiAnswer.innerText = "Bismillah, saya sedang mempelajari perintah tersebut.";
            });
        }

        // Security
        window.triggerSecurityCheck = () => {
            log('üîí Security check triggered');
            const coreStatus = document.getElementById('core-status');
            if (!coreStatus) return;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const latDiff = Math.abs(pos.coords.latitude - (-6.4));
                    const lngDiff = Math.abs(pos.coords.longitude - (106.8));
                    if (latDiff < 0.5 && lngDiff < 0.5) {
                        coreStatus.innerText = "SECURE (IN DEPOK)";
                        coreStatus.className = "text-blue-400 font-bold";
                        alert("‚úÖ Device Secure.");
                    } else {
                        coreStatus.innerText = "‚ö†Ô∏è OUTSIDE SAFE CORE";
                        coreStatus.className = "text-yellow-500";
                    }
                    log(`üìç GPS: ${pos.coords.latitude}, ${pos.coords.longitude}`);
                }, () => {
                    coreStatus.innerText = "GPS DISABLED";
                    coreStatus.className = "text-yellow-500";
                    log('‚ùå GPS denied');
                });
            } else {
                coreStatus.innerText = "GPS NOT SUPPORTED";
            }
        };

        // Analytics
        function loadAnalytics() {
            log('üìà Loading analytics...');
            const ctx = document.getElementById('bookingChart')?.getContext('2d');
            if (!ctx) { log('‚ùå Canvas not found'); return; }
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                    datasets: [{
                        label: 'Booking',
                        data: [2, 5, 3, 8, 4, 1, 0],
                        borderColor: '#8b5cf6',
                        tension: 0.4,
                        backgroundColor: 'rgba(139,92,246,0.2)',
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            log('‚úÖ Chart created');
        }

        // Approval (contoh)
        async function loadApprovals() {
            try {
                const { data: bookings } = await supabase.from('bookings').select('*').eq('status', 'pending').limit(5);
                const bookingDiv = document.getElementById('approval-booking');
                if (bookingDiv) {
                    if (bookings && bookings.length) {
                        bookingDiv.innerHTML = bookings.map(b => `
                            <div class="flex justify-between items-center bg-slate-700 p-3 rounded-xl">
                                <span class="text-xs">${b.nama} - ${b.sarana}</span>
                                <div>
                                    <button onclick="updateStatus('bookings','${b.id}','approved')" class="bg-green-600 px-3 py-1 rounded text-[10px]">‚úì</button>
                                    <button onclick="updateStatus('bookings','${b.id}','rejected')" class="bg-red-600 px-3 py-1 rounded text-[10px]">‚úó</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        bookingDiv.innerHTML = '<p class="text-xs text-slate-400">Tidak ada pending booking</p>';
                    }
                }
            } catch (err) { log(`‚ùå Error load approvals: ${err.message}`); }
        }
        window.updateStatus = async (table, id, status) => {
            try {
                await supabase.from(table).update({ status }).eq('id', id);
                log(`‚úÖ ${table} ${id} updated to ${status}`);
                loadApprovals();
            } catch (err) { log(`‚ùå Error update: ${err.message}`); }
        };
        loadApprovals();

        // ========== GLOBAL SEARCH HUB ==========
        let searchTimeout = null;
        const searchInput = document.getElementById('global-search-input');
        const searchResults = document.getElementById('search-results');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (searchTimeout) clearTimeout(searchTimeout);
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                searchTimeout = setTimeout(() => performSearch(query), 300);
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }

        async function performSearch(query) {
            log(`üîç Searching for: "${query}"`);
            searchResults.innerHTML = '<div class="p-3 text-slate-400">Memuat...</div>';
            searchResults.classList.remove('hidden');

            try {
                const results = [];

                // 1. Search di Bookings
                const { data: bookings } = await supabase
                    .from('bookings')
                    .select('id, nama, sarana, tanggal_mulai, status')
                    .or(`nama.ilike.%${query}%,sarana.ilike.%${query}%,keperluan.ilike.%${query}%`)
                    .limit(3);
                if (bookings?.length) {
                    results.push({ type: 'üìÖ Booking', icon: 'üìÖ', items: bookings });
                }

                // 2. Search di Assets
                const { data: assets } = await supabase
                    .from('assets')
                    .select('id, nama_asset, kategori, lokasi, kondisi')
                    .or(`nama_asset.ilike.%${query}%,kategori.ilike.%${query}%,lokasi.ilike.%${query}%`)
                    .limit(3);
                if (assets?.length) {
                    results.push({ type: 'üè¢ Asset', icon: 'üè¢', items: assets });
                }

                // 3. Search di K3 Reports
                const { data: k3s } = await supabase
                    .from('k3_reports')
                    .select('id, tanggal, lokasi, jenis_laporan, pelapor')
                    .or(`lokasi.ilike.%${query}%,jenis_laporan.ilike.%${query}%,pelapor.ilike.%${query}%,deskripsi.ilike.%${query}%`)
                    .limit(3);
                if (k3s?.length) {
                    results.push({ type: '‚ö†Ô∏è K3', icon: '‚ö†Ô∏è', items: k3s });
                }

                // 4. Search di Maintenance
                const { data: maintenance } = await supabase
                    .from('maintenance_requests')
                    .select('id, lokasi, deskripsi, prioritas, status')
                    .or(`lokasi.ilike.%${query}%,deskripsi.ilike.%${query}%`)
                    .limit(3);
                if (maintenance?.length) {
                    results.push({ type: 'üîß Maintenance', icon: 'üîß', items: maintenance });
                }

                // 5. Search di Stok
                const { data: stok } = await supabase
                    .from('stok')
                    .select('id, nama_barang, kategori, jumlah, lokasi')
                    .or(`nama_barang.ilike.%${query}%,kategori.ilike.%${query}%`)
                    .limit(3);
                if (stok?.length) {
                    results.push({ type: 'üì¶ Stok', icon: 'üì¶', items: stok });
                }

                // 6. Search di SPJ
                const { data: spj } = await supabase
                    .from('spj')
                    .select('id, judul, nominal, status')
                    .ilike('judul', `%${query}%`)
                    .limit(3);
                if (spj?.length) {
                    results.push({ type: 'üìÑ SPJ', icon: 'üìÑ', items: spj });
                }

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="p-4 text-center text-slate-400">Tidak ada hasil</div>';
                    return;
                }

                let html = '';
                results.forEach(group => {
                    html += `<div class="p-2 border-b border-slate-700 last:border-0">`;
                    html += `<div class="text-xs font-bold text-purple-400 mb-1">${group.icon} ${group.type}</div>`;
                    group.items.forEach(item => {
                        if (group.type.includes('Booking')) {
                            html += `<div class="p-2 hover:bg-slate-800 rounded cursor-pointer" onclick="window.goToBooking('${item.id}')">`;
                            html += `<div class="text-sm">${item.nama} - ${item.sarana}</div>`;
                            html += `<div class="text-[10px] text-slate-400">${item.tanggal_mulai} | ${item.status}</div>`;
                        } else if (group.type.includes('Asset')) {
                            html += `<div class="p-2 hover:bg-slate-800 rounded cursor-pointer" onclick="window.goToAsset('${item.id}')">`;
                            html += `<div class="text-sm">${item.nama_asset}</div>`;
                            html += `<div class="text-[10px] text-slate-400">${item.kategori} | ${item.lokasi} | ${item.kondisi}</div>`;
                        } else if (group.type.includes('K3')) {
                            html += `<div class="p-2 hover:bg-slate-800 rounded cursor-pointer" onclick="window.goToK3('${item.id}')">`;
                            html += `<div class="text-sm">${item.lokasi} - ${item.jenis_laporan}</div>`;
                            html += `<div class="text-[10px] text-slate-400">${item.tanggal} | ${item.pelapor}</div>`;
                        } else if (group.type.includes('Maintenance')) {
                            html += `<div class="p-2 hover:bg-slate-800 rounded cursor-pointer" onclick="window.goToMaintenance('${item.id}')">`;
                            html += `<div class="text-sm">${item.lokasi}</div>`;
                            html += `<div class="text-[10px] text-slate-400">${item.deskripsi.substring(0,50)}... | ${item.prioritas}</div>`;
                        } else if (group.type.includes('Stok')) {
                            html += `<div class="p-2 hover:bg-slate-800 rounded cursor-pointer" onclick="window.goToStok('${item.id}')">`;
                            html += `<div class="text-sm">${item.nama_barang}</div>`;
                            html += `<div class="text-[10px] text-slate-400">${item.kategori} | Stok: ${item.jumlah} | ${item.lokasi}</div>`;
                        } else if (group.type.includes('SPJ')) {
                            html += `<div class="p-2 hover:bg-slate-800 rounded cursor-pointer" onclick="window.goToSPJ('${item.id}')">`;
                            html += `<div class="text-sm">${item.judul}</div>`;
                            html += `<div class="text-[10px] text-slate-400">Rp ${Number(item.nominal).toLocaleString()} | ${item.status}</div>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
                searchResults.innerHTML = html;

            } catch (err) {
                log(`‚ùå Search error: ${err.message}`);
                searchResults.innerHTML = '<div class="p-3 text-red-400">Error saat mencari</div>';
            }
        }

        // Navigasi sementara (bisa diganti dengan router)
        window.goToBooking = (id) => alert('üîç Detail Booking ID: ' + id);
        window.goToAsset = (id) => alert('üè¢ Detail Asset ID: ' + id);
        window.goToK3 = (id) => alert('‚ö†Ô∏è Detail K3 ID: ' + id);
        window.goToMaintenance = (id) => alert('üîß Detail Maintenance ID: ' + id);
        window.goToStok = (id) => alert('üì¶ Detail Stok ID: ' + id);
        window.goToSPJ = (id) => alert('üìÑ Detail SPJ ID: ' + id);

        log('‚úÖ Command Center initialized. Bismillah!');
    })();
</script>
</body>
</html>
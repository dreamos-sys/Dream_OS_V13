<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Sarana - Dream OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Plus Jakarta Sans', sans-serif; }
        input, select { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-2xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-500">
            üìÖ Form Booking Sarana
        </h1>

        <form id="bookingForm" class="space-y-4">
            <div>
                <label class="text-xs uppercase text-slate-400">Nama Pemohon</label>
                <input type="text" name="nama" id="nama" placeholder="Erwinsyah" class="w-full p-3 rounded-xl" required>
            </div>

            <div>
                <label class="text-xs uppercase text-slate-400">Nomor HP</label>
                <input type="tel" name="no_hp" id="no_hp" placeholder="0812xxxxxxx" class="w-full p-3 rounded-xl" required>
            </div>

            <div>
                <label class="text-xs uppercase text-slate-400">Divisi</label>
                <select name="divisi" id="divisi" class="w-full p-3 rounded-xl">
                    <option value="SD">Unit SD</option>
                    <option value="SMP">Unit SMP</option>
                    <option value="SMA">Unit SMA</option>
                    <option value="Umum">Bagian Umum</option>
                </select>
            </div>

            <div>
                <label class="text-xs uppercase text-slate-400">Sarana</label>
                <select name="sarana" id="sarana" class="w-full p-3 rounded-xl" required></select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                    <label class="text-xs uppercase text-slate-400">Tanggal</label>
                    <input type="date" name="tgl_mulai" id="tgl_mulai" class="w-full p-3 rounded-xl" required>
                </div>
                <div>
                    <label class="text-xs uppercase text-slate-400">Jam Mulai</label>
                    <input type="time" name="jam_mulai" id="jam_mulai" class="w-full p-3 rounded-xl" required>
                </div>
                <div>
                    <label class="text-xs uppercase text-slate-400">Jam Selesai</label>
                    <input type="time" name="jam_selesai" id="jam_selesai" class="w-full p-3 rounded-xl" required>
                </div>
            </div>

            <div>
                <label class="text-xs uppercase text-slate-400">Peralatan (opsional)</label>
                <div id="alat-container" class="grid grid-cols-2 md:grid-cols-3 gap-3 bg-slate-800/50 p-4 rounded-2xl"></div>
            </div>

            <div id="form-result" class="text-center text-sm min-h-[40px]"></div>

            <button type="submit" id="submitBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold text-lg shadow-lg hover:scale-[1.02] active:scale-95 transition">
                SUBMIT BOOKING
            </button>
        </form>
    </div>

    <!-- ===== JAVASCRIPT LANGSUNG DI SINI ===== -->
    <script>
        (function() {
            'use strict';

            // ===== DATA LISTS (sudah dibersihkan dari spasi & typo) =====
            const SARANA_LIST = [
                "Aula SMP", "Aula SMA", "Saung Besar", "Saung Kecil",
                "Masjid (Maintenance)", "Mushalla SMA", "Serbaguna",
                "Lapangan Basket", "Lapangan Volly", "Lapangan Tanah",
                "Lapangan SMA", "Kantin SMP", "Kantin SMA",
                "Labkom SD", "Labkom SMP", "Labkom SMA",
                "Perpustakaan SD", "Perpustakaan SMP", "Perpustakaan SMA",
                "Area Taman Depan Masjid", "Area Parkir Depan Dapur",
                "Area Parkir Loby SMA"
            ];

            const ALAT_LIST = [
                "Sound Portable", "Projector", "Standing Mic",
                "Meja Panjang", "Kursi Futura", "Taplak Meja",
                "TV", "Layar Projektor"
            ];

            // ===== CACHE ELEMENTS =====
            const elements = {
                sarana: document.getElementById('sarana'),
                alatContainer: document.getElementById('alat-container'),
                bookingForm: document.getElementById('bookingForm'),
                formResult: document.getElementById('form-result'),
                submitBtn: document.getElementById('submitBtn')
            };

            // ===== INIT DROPDOWN SARANA =====
            if (elements.sarana) {
                elements.sarana.innerHTML = SARANA_LIST.map(s => 
                    `<option value="${s}">${s}</option>`
                ).join('');
                console.log('üìç Sarana options loaded:', SARANA_LIST.length);
            }

            // ===== INIT CHECKBOX ALAT =====
            if (elements.alatContainer) {
                elements.alatContainer.innerHTML = ALAT_LIST.map((a, i) => `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="alat-${i}" value="${a}" class="w-4 h-4 accent-purple-500">
                        <label for="alat-${i}" class="text-[11px] text-slate-300 select-none cursor-pointer">${a}</label>
                    </div>
                `).join('');
                console.log('üîß Alat options loaded:', ALAT_LIST.length);
            }

            // ===== INIT DATE PICKER & AUTO JAM =====
            const tglInput = document.getElementById('tgl_mulai');
            if (tglInput) {
                tglInput.setAttribute('min', new Date().toISOString().split('T')[0]);
                const hour = new Date().getHours();
                if (hour < 12) {
                    document.getElementById('jam_mulai').value = '07:30';
                    document.getElementById('jam_selesai').value = '12:00';
                } else if (hour < 15) {
                    document.getElementById('jam_mulai').value = '12:00';
                    document.getElementById('jam_selesai').value = '16:00';
                } else {
                    document.getElementById('jam_mulai').value = '07:30';
                    document.getElementById('jam_selesai').value = '16:00';
                }
            }

            // ===== HANDLE SUBMIT =====
            if (elements.bookingForm) {
                elements.bookingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const resDiv = elements.formResult;
                    const btn = elements.submitBtn;

                    // Ambil alat terpilih
                    const alatTerpilih = [];
                    ALAT_LIST.forEach((a, i) => {
                        const cb = document.getElementById(`alat-${i}`);
                        if (cb?.checked) alatTerpilih.push(a);
                    });

                    const payload = {
                        nama: form.nama.value.trim(),
                        no_hp: form.no_hp.value.trim(),
                        divisi: form.divisi.value,
                        sarana: form.sarana.value,
                        tgl: form.tgl_mulai.value,
                        jamM: form.jam_mulai.value,
                        jamS: form.jam_selesai.value,
                        alat: alatTerpilih.join(', ')
                    };

                    // Validasi
                    if (!payload.nama || !payload.no_hp || !payload.sarana || !payload.tgl) {
                        resDiv.innerHTML = '<span class="text-red-500">‚ö†Ô∏è Nama, No HP, Sarana, dan Tanggal wajib diisi!</span>';
                        return;
                    }
                    if (!/^[0-9]{10,15}$/.test(payload.no_hp.replace(/\D/g, ''))) {
                        resDiv.innerHTML = '<span class="text-red-500">‚ö†Ô∏è Nomor HP tidak valid (minimal 10 angka)!</span>';
                        return;
                    }

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                    resDiv.innerHTML = 'üîç Checking ketersediaan...';

                    try {
                        // Cek bentrok
                        const { data: existing, error: fetchError } = await window.supabase
                            .from('bookings')
                            .select('jam_mulai, jam_selesai')
                            .eq('ruang', payload.sarana)
                            .eq('tanggal', payload.tgl)
                            .eq('status', 'approved');

                        if (fetchError) throw fetchError;

                        let isBentrok = false;
                        if (existing) {
                            existing.forEach(b => {
                                if (payload.jamM < b.jam_selesai && payload.jamS > b.jam_mulai) {
                                    isBentrok = true;
                                }
                            });
                        }

                        const statusFinal = isBentrok ? 'pending' : 'approved';

                        // Insert ke Supabase
                        const { error: insertError } = await window.supabase
                            .from('bookings')
                            .insert([{
                                nama_peminjam: payload.nama,
                                no_hp: payload.no_hp,
                                divisi: payload.divisi,
                                ruang: payload.sarana,
                                tanggal: payload.tgl,
                                jam_mulai: payload.jamM,
                                jam_selesai: payload.jamS,
                                peralatan: payload.alat,
                                status: statusFinal,
                                notes: isBentrok ? 'Conflict - Waiting approval' : 'Auto-Approved - No conflict',
                                created_at: new Date().toISOString()
                            }]);

                        if (insertError) throw insertError;

                        if (statusFinal === 'approved') {
                            resDiv.innerHTML = '<span class="text-emerald-400 text-lg">‚úÖ AUTO-APPROVED!<br><span class="text-sm">Jadwal Berhasil Dikunci.</span></span>';
                            form.reset();
                        } else {
                            resDiv.innerHTML = '<span class="text-amber-400 text-lg">üìã PENDING<br><span class="text-sm">Ada bentrok, menunggu Pak Hanung.</span></span>';
                        }
                    } catch (err) {
                        console.error(err);
                        resDiv.innerHTML = `<span class="text-red-500 text-lg">‚ùå Error: ${err.message}<br><span class="text-sm">Coba lagi atau hubungi admin.</span></span>`;
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = 'SUBMIT BOOKING';
                    }
                });
            }
        })();
    </script>
</body>
</html>